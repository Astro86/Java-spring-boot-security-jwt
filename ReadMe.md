# Spring Security 그리고 REST API JWT 인증

지금까지 공부해온 Spring Security 를 활용하여 REST API JWT Token 인증 시스템을 구현해 보도록 하겠습니다.

REST API를 디자인 할 때는 매우 중요한 보안을 탄탄하게 잡아줘야 합니다. 
마침 Spring 기반의 애플리케이션 <b>Spring Security</b> 라는 아주 훌륭한 <b>인증 및 권한</b> 부여 솔루션이 존재합니다.

## Spring Security(스프링 시큐리티) 란 무엇인가?

스프링 시큐리티 레퍼런스에서는 자바 EE 기반의 엔터프라이즈 소프트웨어 애플리케이션을 위한 포괄적인 보안 서비스들을 제공하고 
<b>오픈 플랫폼</b>이면서 자신만의 인증 매커니즘을 간단하게 만들 수 있습니다.

스프링 시큐리티를 이해하기 위해서는 스프링 시큐리티가 <b>애플리케이션 보안을 구성하는 두가지 영역</b>에 대해서 알아야 합니다. 

바로 <b>인증(Authentication)과 권한(Authorization)</b> 이라는 것입니다.

- 인증 : 애플리케이션의 작업을 수행할 수 있는 주체(사용자)라고 주장할 수 있는 것
- 권한 : 권한은 인증된 주체가 애플리케이션의 동작을 수행할 수 있도록 허락되있는지를 결정하는 것

권한 승인이 필요한 부분으로 접근하려면 인증 과정을 통해 주체가 증명 되어야만 한다는 것입니다.

## Spring Security 동작 방식

- 1. 클라이언트가 Resource에 URL을 통해 요청을 보낸다.
- 2. <b>DelegatingFilterProxy</b>는 요청을 Intercept! 가로채서 Spring Security빈으로 보낸다.
- 3. Spring Security빈은 인증 및 권한을 확인한다.
- 4. 권한이 잘 부여되어 있다면 리소스에 접근을 허용하고 그렇지 않다면 거부한다.

## JWT (JSON Web Token) 이란?

JSON Web Token (JWT) 은 웹표준 <a href="https://tools.ietf.org/html/rfc7519">(RFC 7519)</a> 으로서 
두 개체에서 JSON 객체를 사용하여 가볍고 자가수용적인 (self-contained) 방식으로 정보를 안전성 있게 전달해줍니다.

JSON 객체로서 안전하게 정보를 전송할 수 있는 작고 self-contained 방법을 정의하는 표준이다.

### 많은 프로그래밍 언어의 지원

JWT 는 C, Java, Python, C++, R, C#, PHP, JavaScript, Ruby, Go, Swift 등 대부분의 주류 프로그래밍 언어에서 지원됩니다.

### 자가 수용적 (self-contained)

JWT 는 <b>필요한 모든 정보를 자체적으로</b> 지니고 있습니다. 
JWT 시스템에서 발급된 토큰은, <b>토큰에 대한 기본정보</b> 그리고 <b>전달 할 정보</b> (로그인시스템에서는 유저 정보) 그리고 토큰이 <b>검증됐다는것을 증명해주는 signature</b> 를 포함하고있습니다.

### 쉬운 전달

JWT 는 자가수용적이므로, 두 개체 사이에서 손쉽게 전달 될 수 있습니다. 웹서버의 경우 HTTP의 헤더에 넣어서 전달 할 수도 있고, URL 의 파라미터로 전달 할 수도 있습니다.

## JWT를 유용하게 사용하는 상황

- 회원 인증

JWT 를 사용하는 가장 흔한 경우 회원 인증 입니다. 
유저가 로그인을 하면, 서버는 <b>유저의 정보에 기반한 토큰을 발급하여 유저에게 전달</b>해줍니다. 
그 후, <b>유저가 서버에 요청을 할 때 마다 JWT를 포함하여 전달</b>합니다. 
서버가 클라이언트에게서 요청을 받을때 마다, <b>해당 토큰이 유효하고 인증됐는지 검증</b>을 하고, 
유저가 요청한 작업에 권한이 있는지 확인하여 작업을 처리합니다.
중요! <b>서버측에서는 유저의 세션을 유지 할 필요가 없습니다. </b>
즉 유저가 로그인되어있는지 안되어있는지 신경 쓸 필요가 없고, 
유저가 요청을 했을때 <b>토큰만 확인</b>하면 되니, 세션 관리가 필요 없어서 <b>서버 자원을 많이 아낄 수 있다.</b>

- 정보 교류

JWT는 두 개체 사이에서 <b>안정성있게 정보를 교환하기에 좋은 방법</b>입니다. 
그 이유는, 정보가 sign 이 되어있기 때문에 정보를 보낸이가 바뀌진 않았는지,
또 <b>정보가 도중에 조작되지는 않았는지 검증</b>할 수 있습니다.

## JWT 코드의 구조

JWT 는 . 을 구분자로 <b>3가지의 문자열</b>로 되어있습니다. 구조는 다음과 같이 이루어져있습니다

aaa.bbb.ccc -> header.payload.signature

(헤더, 내용, 서명) 순으로 이루어있는 문자열 입니다.

### 헤더 Header

Header는 두가지 정보를 지니고 있습니다.

- typ : 토큰의 타입을 지정합니다.
- alg : 해싱 알고리즘을 지정합니다. 해싱 알고리즘은 보통 HMAC SHA256 혹은 RSA가 사용되며 토큰을 검증 할 때 사용되는 signature 부분에서 사용됩니다.

### 정보 Payload

Payload 부분에는 <b>토큰에 담을 정보</b>가 들어있습니다. 
여기에 담는 정보의 한 <b>‘조각’ 을 클레임(claim)</b> 이라고 부르고, 
이는 name / value 의 한 쌍으로 이뤄져있습니다. 
토큰에는 여러개의 클레임 들을 넣을 수 있습니다.

클레임 의 종류는 다음과 같이 크게 세 분류로 나뉘어져있습니다.

- 등록된 (registered) 클레임
- 공개 (public) 클레임
- 비공개 (private) 클레임

#### 등록된 (registered) 클레임

등록된 클레임들은 서비스에서 필요한 정보들이 아닌, 
토큰에 대한 정보들을 담기위하여 이름이 이미 정해진 클레임들입니다. 
등록된 클레임의 <b>사용은 모두 선택적 (optional)</b>이며, 
이에 포함된 클레임 이름들은 다음과 같습니다.

- iss: 토큰 발급자 (issuer)
- sub: 토큰 제목 (subject)
- aud: 토큰 대상자 (audience)
- exp: 토큰의 만료시간 (expiraton), 시간은 NumericDate 형식으로 되어있어야 하며 (예: 1480849147370) 언제나 <b>현재 시간보다 이후</b>로 설정되어있어야합니다.
- nbf: Not Before 를 의미하며, 토큰의 활성 날짜와 비슷한 개념입니다. 여기에도 NumericDate 형식으로 날짜를 지정하며, <b>이 날짜가 지나기 전까지는 토큰이 처리되지 않습니다.</b>
- iat: 토큰이 발급된 시간 (issued at), 이 값을 사용하여 <b>토큰의 age 가 얼마나 되었는지 판단</b> 할 수 있습니다.
- jti: JWT의 고유 식별자로서, 주로 <b>중복적인 처리를 방지</b>하기 위하여 사용됩니다. 일회용 토큰에 사용하면 유용합니다.

#### 공개 (public) 클레임

공개 클레임들은 <b>충돌이 방지된 (collision-resistant)</b> 이름을 가지고 있어야 합니다. 
충돌을 방지하기 위해서는, <b>클레임 이름을 URI 형식</b>으로 짓습니다.

{% highlight matlab %}
{
    "http://localhost:3000/boardEvent/write": true
}
{% endhighlight %}

#### 비공개 (private) 클레임

등록된 클레임도아니고, 공개된 클레임들도 아닙니다. 
양 측간에 (보통 클라이언트 <->서버) 협의하에 사용되는 클레임 이름들입니다. 
공개 클레임과는 달리 이름이 중복되어 충돌이 될 수 있으니 사용할때에 유의해야합니다.

{% highlight matlab %}
{
    "username": "jjunpro"
}
{% endhighlight %}

결국 JWT Token 을 전체적으로 확인해보면 

{% highlight matlab %}
{
    "iss": "admin",
    "exp": "148794004800",
    "http://localhost:3000/boardEvent/write": true,
    "userId": "38048322648",
    "username": "jjunpro"
}
{% endhighlight %}

이런 형식의 토큰 코드가 완성됩니다.

### 서명 (signature)

JSON Web Token 의 마지막 부분은 바로 서명(signature) 입니다. 
이 서명은 <b>헤더의 인코딩값</b>과, <b>정보의 인코딩값</b>을 합친 후 주어진 비밀키로 해쉬를 하여 생성합니다.

# 공부에 도움이 많이 된 출처!

https://velopert.com/2389 - [JSON Web Token 이 뭘까?]